groups:
  - name: sportsbook.orleans
    interval: 30s
    rules:
      # Orleans Silo Health
      - alert: OrleansSiloDown
        expr: up{job="orleans-silo"} == 0
        for: 1m
        labels:
          severity: critical
          service: orleans
        annotations:
          summary: "Orleans Silo is down"
          description: "Orleans Silo {{ $labels.instance }} has been down for more than 1 minute."

      # High grain activation failures
      - alert: HighGrainActivationFailures
        expr: increase(sportsbook_orleans_grain_activations_failed_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: orleans
        annotations:
          summary: "High grain activation failures"
          description: "{{ $value }} grain activations failed in the last 5 minutes on {{ $labels.instance }}"

      # High request latency
      - alert: HighOrleansSiloLatency
        expr: histogram_quantile(0.95, sportsbook_orleans_request_duration_seconds_bucket) > 1.0
        for: 2m
        labels:
          severity: warning
          service: orleans
        annotations:
          summary: "High Orleans request latency"
          description: "95th percentile latency is {{ $value }}s on {{ $labels.instance }}"

      # Memory usage
      - alert: HighOrleansSiloMemoryUsage
        expr: process_resident_memory_bytes{job="orleans-silo"} / 1024 / 1024 / 1024 > 2.0
        for: 5m
        labels:
          severity: warning
          service: orleans
        annotations:
          summary: "High Orleans Silo memory usage"
          description: "Orleans Silo {{ $labels.instance }} is using {{ $value }}GB of memory"

  - name: sportsbook.api
    interval: 30s
    rules:
      # API Health
      - alert: SportsbookAPIDown
        expr: up{job="sportsbook-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "Sportsbook API is down"
          description: "Sportsbook API {{ $labels.instance }} has been down for more than 1 minute."

      # High error rate
      - alert: HighAPIErrorRate
        expr: rate(sportsbook_api_requests_total{status=~"5.."}[5m]) / rate(sportsbook_api_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High API error rate"
          description: "API error rate is {{ $value }}% on {{ $labels.instance }}"

      # High response time
      - alert: HighAPIResponseTime
        expr: histogram_quantile(0.95, sportsbook_api_request_duration_seconds_bucket) > 2.0
        for: 2m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High API response time"
          description: "95th percentile response time is {{ $value }}s on {{ $labels.instance }}"

  - name: sportsbook.infrastructure
    interval: 30s
    rules:
      # PostgreSQL
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database {{ $labels.instance }} is down"

      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "PostgreSQL high connection usage"
          description: "PostgreSQL is using {{ $value }}% of max connections"

      # Redis
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis instance {{ $labels.instance }} is down"

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis high memory usage"
          description: "Redis is using {{ $value }}% of available memory"

      # System resources
      - alert: HighCPUUsage
        expr: 100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }}"

      - alert: LowDiskSpace
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Low disk space"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }}"